include "root" {
  path = find_in_parent_folders()
}

# Use Terragrunt to download the module code
terraform {
  source = "${get_parent_terragrunt_dir()}/../../terraform//helm"
}

dependency "iam" {
  config_path  = "../iam"
  skip_outputs = true
}

dependency "cluster" {
  config_path = "../cluster"

  mock_outputs = {
    kube_config = {
      server      = "http://my-k8s.cluster.dev",
      client_key  = "***REMOVED***=="
      client_cert = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJVVMwOHlaTjFtUTh3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TVRBNU1ETXhOVEUyTURCYUZ3MHlNakV5TURJeE16TTNNakphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXdBbElZcEhEV2JONmx5ZWMKR3FKK2NxblI0NGdLbFVRQWZQM21FVVJIelB1Zk80bFo4WjRVNlNSUERBSGNpc0JBN1NXYU5kTXE5M0xSdGpVWQpOUUR6bllIelpOWmp5WVlHekF6MmsyWXJBMFV1TXlrTmFKVEhyQVBWcXFCeVEzUWlYdXlqdVNpVG16RDBKSWtiClArekVwdWx6UWN6OURNb3hJSVZKMDRtOXZoQWRTV3p6K0JRc2dvZUZ5RG0zcXdSL0xNMjg2L2tXVDVsdkZuOEgKd003cGZzQ0JValQrWTJWWDdLOU0xWnc4WUZhY0l5N1B1aXZVVkthNkdWeUUvZmhrV3Y2NiszRzB3ZTNwdE9mYQo3ME10Vk5wSTJDcWNxandwS2xNUmNaaFJEcDdMb2VXRGJEaEhFOTVTVDdhdTV6c05aV2lDSkVkcXNGSDlxWlBjCkdId3AvUUlEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JUSE5qd1Foc2g5U3JGazY3VFZGTGtHZ1BGdwpGakFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBZnRyOWxEaGFCV25SbUhjQkhLYjI4cVpnbXBQaGd2c3RZaFlRCmdkSHNmaFJaZHV0emEraUV4Zyt5YUQ1M0tZT2ZmWEZvS3g4M3FYT1cwY2dZVHV0N0dtc2tiSVJINE5ZNTZRZ3MKdHREMnBKS0RONFdRMmU5NHhwendydGs3T05UQ3g3bWdOVG11ZGlYVjJPd3VuV0IzSXprMHd4T2hqNjhBOFdCaQpCb3BCelcvTHI2TWZIVVVhTGJzUWZpRTZKSDBDcmlnNXpJMG9ma0Vydzc3aXVZVm9sKzhibEV3YmdHOHlBUkg3CkdibHdEdEhYR2gyb2I5bHhTWUdPNmVyYUd6YWtlUFJ4YWVrMUpCdFdGd1E5cVRiZ3pwaisvVVhrZFMxSmVIOWgKaUFaOCtRTUtvanBreUJhUU5NTEdrWngwTDlvbHFkazh5Wmd3RHdabVJtN3YzVXNBZnc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg=="
      ca_certs    = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lNRnFyRGV3c2wxcWdwaDg1S01BMEdDU3FHU0liM0RRRUJDd1VBTUJVeEV6QVIKQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13SGhjTk1qRXhNREF5TURjek1qSTRXaGNOTXpFeE1EQXlNRGN6TWpJNApXakFWTVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBCk1JSUJDZ0tDQVFFQXVzL3BEMGMwbDN4eDJvdzNKZTdkSytkUzNpS2NjRzAxalBETEw5dlBGVnhjL1RFVjBJaWEKTGxDclRSaCtmUzVOMndqR2RFakZsSU1FSzVnNEV1dVdjOXVVYmQyNU81SHg1RnA4R2hMQ2M5ZEtDN3dQNThnRwpQUlVEcVowN0NKeklqalhtTWNzWDVFSm9IakoweHdWdmQ0M2ZQMDVmVHdrZjFDVmZqd3hCdlJpcGNxRnl5TEQzCmh5dy9qanNqVGIvVHpJdXh4ZzJMWVM3bHd4R3NJeDYvc0FWWlNiRzZIUWZWQzYxNktHZHIwdUZ6QkttUTRvSzcKb0w0SEYxMFJyTmNYTkppSnlOQ0h4YkhBZFNPN1hncW84SVNxa01zT1lPbFdidW9rajhmNjk4OG92RjA4bFFzMAo0eGl0QzZ4VmFqODVQTzdaYzdkeGFQWFlwbHNSN0RrMDN3SURBUUFCbzBJd1FEQU9CZ05WSFE4QkFmOEVCQU1DCkFRWXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVVHVFgxQWpldjhseGdRRkMzWi9ZbTBUNTcKb1NBd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFLRlNOVmpCTEEwTkdOTDBJMnpMUzFIY2RSemU4bit6MkdBQQpRWDZpRWZ5M0Uvb3duTGdpRWdEN2x6d094L1lGR2pIdmZIVU12NVJEY1pLc3c3dVBPbFI4aVdXRkh1UnMyNjYrCnFPaHhyVXE0MVhSaTFrUGc4SkpWd3BQc1lPOXRjd2RrdjF4WDJaeUxTUG9heGh3NjdRLzBOcmxDMkl1OVJWQjIKQjJlR1hmTzgzOWtWaU9mblY3RXF5WDYrcXg0aVpCaEYycjNoVVozTEZxOVpRYnNWVWJsWnhJaXNmWU96S0NnMQo1NFBGQWN2WDM3aDVkSWRQbW1RTnNweXlldVY4TXB1WGNNbmN1cjM3em9BcE5YOFR0dDZkYmJBeVJLRGlXREVsCnBSQWtFWXAzaEFuNEVyOTU4Nkc1Sm1zUWlOLzJlS2ZLazloYyt3dWd6UTEza0pZd2hiUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo="
    }
  }
}

locals {
  vars = read_terragrunt_config(find_in_parent_folders("terragrunt.hcl"))
}

inputs = merge(
  local.vars.locals.customer_vars,
  {
    k8s_host                   = dependency.cluster.outputs.kube_config.server,
    k8s_client_key             = base64encode(dependency.cluster.outputs.kube_config.client_key),
    k8s_cluster_ca_certificate = base64encode(dependency.cluster.outputs.kube_config.ca_certs),
    k8s_client_certificate     = base64encode(dependency.cluster.outputs.kube_config.client_cert),
    subdomain                  = local.vars.locals.subdomain
  }
)
